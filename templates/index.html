<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SFTP Simple Client — Fixed</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@phosphor-icons/web@2.1.1"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>

  <style>
    :root { --primary: #4f46e5; --primary-dark: #4338ca; }
    html, body { height: 100%; }
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }

    #explorer-content { scrollbar-width: thin; scrollbar-color: var(--primary) #e5e7eb; max-height: 75vh; overflow-y: auto; }
    #explorer-content::-webkit-scrollbar { width: 8px; }
    #explorer-content::-webkit-scrollbar-thumb { background-color: var(--primary); border-radius: 4px; }
    #explorer-content::-webkit-scrollbar-track { background-color: #e5e7eb; border-radius: 4px; }

    .file-icon { display:inline-block; width:20px; height:20px; vertical-align:middle; }
    .folder-icon { /* your CSS */ }
    .file-icon-regular { /* your CSS */ }

    #editor-container { display:flex; flex-direction:column; min-height:0; }
    #editor { flex:1 1 auto; min-height:0; height:auto; }

    .icon-fallback { display:none; margin-right:0.5rem; }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <div id="status-toast" class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 opacity-0 pointer-events-none" role="alert"></div>

  <main class="flex flex-1 flex-col md:flex-row p-4 gap-4 min-h-screen">

    <div class="flex flex-col gap-4 md:w-1/3 lg:w-1/4">

      <div id="connection-panel" class="bg-white p-4 rounded-xl shadow-lg transition-all duration-300">
        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
          <i class="ph-bold ph-link text-xl mr-2 text-indigo-500"></i> SFTP Connection
        </h2>
        <form id="connection-form" class="space-y-3">
          <input type="text" id="host" value="rasp-alex2.local" placeholder="Host (e.g., rasp-alex2.local)"
                 class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
          <div class="flex gap-2">
            <input type="number" id="port" value="22" placeholder="Port"
                   class="w-1/3 p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <input type="text" id="username" value="rasp-alex2" placeholder="Username"
                   class="w-2/3 p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <input type="password" id="password" value="120313" placeholder="Password"
                 class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
          <button type="submit" id="connect-btn"
                  class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-lg shadow-md transition-colors duration-200 flex items-center justify-center disabled:opacity-50">
            <i class="ph-fill ph-plug-connected text-lg mr-2"></i> Connect
          </button>
        </form>
      </div>

      <div id="explorer-panel" class="bg-white p-4 rounded-xl shadow-lg flex flex-col flex-1 min-h-[300px] transition-all duration-300 hidden">
        <h2 class="text-xl font-bold text-gray-800 flex items-center mb-2">
          <i class="ph-bold ph-folder-open text-xl mr-2 text-indigo-500"></i> File Explorer
        </h2>

        <div id="current-path" class="text-xs text-gray-500 truncate mb-3 bg-gray-100 p-2 rounded-lg font-mono cursor-pointer hover:bg-gray-200 active:bg-gray-300 transition-colors duration-150" title="Click to go up one level">/</div>

        <div id="explorer-content" class="flex-1 space-y-1">
          <div class="text-center text-gray-500 pt-12">Select a directory to view content.</div>
        </div>
      </div>

    </div>

    <div id="editor-container" class="flex flex-col gap-4 md:w-2/3 lg:w-3/4 bg-white p-4 rounded-xl shadow-lg transition-all duration-300 hidden">
      <h2 class="text-xl font-bold text-gray-800 flex items-center">
        <i class="ph-bold ph-file-text text-xl mr-2 text-indigo-500"></i> <span id="editor-filename">No File Selected</span>
      </h2>

      <div id="editor" style="width:100%"></div>

      <div class="flex justify-end gap-3">
        <button id="save-btn" onclick="saveFile()"
                class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center disabled:opacity-50"
                disabled>
          <i class="ph-fill ph-floppy-disk text-lg mr-2"></i> Save Changes
        </button>
        <button id="close-editor-btn" type="button"
                class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center">
          <i class="ph-fill ph-x-circle text-lg mr-2"></i> Close
        </button>
      </div>
    </div>
  </main>

  <script>
    // API origin — set to your API server
    const apiBaseUrl = 'http://localhost:5000';

    // state
    let currentPath = '/';
    let cwd = '/';
    let selected = null; // {path,is_dir}
    let connected = false;

    function showStatus(message, isError = false) {
      const toast = document.getElementById('status-toast');
      if (!toast) return;
      toast.textContent = message;
      toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 opacity-100 pointer-events-auto ${isError ? 'bg-red-600' : 'bg-green-600'}`;
      setTimeout(() => {
        toast.classList.remove('opacity-100');
        toast.classList.add('opacity-0', 'pointer-events-none');
      }, 2500);
    }

    async function connect() {
      const host = document.getElementById('host').value;
      const port = document.getElementById('port').value || 22;
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      try {
        const res = await fetch(apiBaseUrl + '/connect', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ host, port, username, password })
        });
        const j = await res.json();
        if (j.success) {
          connected = true;
          showStatus('Connected to ' + host);
          cwd = '/';
          currentPath = '/';
          refreshListing();
          const explorerPanel = document.getElementById('explorer-panel');
          if (explorerPanel) explorerPanel.classList.remove('hidden');
        } else {
          alert('Connect error: ' + (j.message || 'unknown'));
          showStatus('Not connected', true);
        }
      } catch (err) {
        showStatus('Connection failed: ' + err.message, true);
      }
    }

    async function disconnect() {
      try { await fetch(apiBaseUrl + '/disconnect', { method: 'POST' }); } catch (_) {}
      connected = false;
      showStatus('Not connected', true);
      document.getElementById('explorer-content').innerHTML = '';
      document.getElementById('current-path').textContent = '';
      document.getElementById('editor-filename').textContent = 'Select a file to view/edit';
      if (window.ace) try { ace.edit(document.getElementById('editor')).setValue(''); } catch(e){}
    }

    function pathJoin(a, b) {
      if (!a) a = '/';
      if (b.startsWith('/')) return b;
      if (a.endsWith('/')) return a + b;
      return a + '/' + b;
    }

    async function refreshListing(path) {
      if (!connected) { alert('Not connected'); return; }
      const target = path || cwd || '/';
      try {
        const res = await fetch(apiBaseUrl + '/api/list?path=' + encodeURIComponent(target));
        const j = await res.json();
        if (!j.success) { alert('Error listing: ' + j.message); return; }
        cwd = target;
        const cwdEl = document.getElementById('current-path');
        if (cwdEl) cwdEl.textContent = cwd;
        renderList(j.items || []);
      } catch (err) {
        showStatus('Error listing: ' + err.message, true);
        document.getElementById('explorer-content').innerHTML = `<div class="p-4 text-center text-red-600">Error loading path: ${err.message}</div>`;
      }
    }

    function renderList(items) {
      const container = document.getElementById('explorer-content');
      if (!container) return;
      container.innerHTML = '';

      if (cwd !== '/') {
        const up = document.createElement('div');
        up.className = 'item p-2 rounded-lg cursor-pointer hover:bg-gray-100';
        up.innerHTML = '<div class="name">⬆ ..</div><div class="meta">Parent</div>';
        up.onclick = () => {
          const parts = cwd.split('/').filter(Boolean);
          parts.pop();
          const np = '/' + parts.join('/');
          refreshListing(np === '/' ? '/' : np);
        };
        container.appendChild(up);
      }

      if (!items || items.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 pt-12">Directory is empty.</div>';
        return;
      }

      items.forEach(it => container.appendChild(createListItem(it.name, it.path, it.is_dir, it.size)));
    }

    function createListItem(name, path, isDir, size) {
      const div = document.createElement('div');
      div.className = 'flex items-center p-2 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors duration-150 group justify-between';
      div.title = path;

      const left = document.createElement('div');
      left.className = 'flex items-center gap-2 flex-1 truncate';

      const iconWrapper = document.createElement('span');
      iconWrapper.className = 'flex items-center gap-2 truncate';

      const fileIcon = document.createElement('span');
      fileIcon.className = isDir ? 'file-icon folder-icon' : 'file-icon file-icon-regular';
      fileIcon.setAttribute('aria-hidden', 'true');

      const phIcon = document.createElement('i');
      phIcon.className = isDir ? 'ph-fill ph-folder icon-fallback text-yellow-500' : 'ph-fill ph-file-text icon-fallback text-gray-500';
      phIcon.setAttribute('aria-hidden', 'true');
      phIcon.style.display = 'none';

      const nameText = document.createElement('span');
      nameText.className = 'truncate text-sm';
      nameText.textContent = name;

      iconWrapper.appendChild(fileIcon);
      iconWrapper.appendChild(phIcon);
      left.appendChild(iconWrapper);
      left.appendChild(nameText);

      const meta = document.createElement('div');
      meta.className = 'text-xs text-gray-500 ml-3';
      meta.textContent = isDir ? 'Folder' : `${size ?? '-'} bytes`;

      div.appendChild(left);
      div.appendChild(meta);

      div.onclick = () => { if (isDir) refreshListing(path); else readFile(path); };

      div.oncontextmenu = (e) => {
        e.preventDefault();
        selected = { path, is_dir: isDir };
        updateSelectionUI();
        const action = prompt('Actions: rename / delete / download (type one)', '');
        if (!action) return;
        if (action === 'rename') renameSelected();
        if (action === 'delete') removeSelected();
        if (action === 'download') downloadSelected();
      };

      // check if custom icon is visible; otherwise show fallback
      setTimeout(() => {
        try {
          const cs = window.getComputedStyle(fileIcon);
          const hasBg = (cs && cs.backgroundImage && cs.backgroundImage !== 'none') || (parseFloat(cs.width) > 0 && parseFloat(cs.height) > 0 && (fileIcon.innerHTML || '').trim() !== '');
          if (!hasBg) phIcon.style.display = 'inline-block';
          else phIcon.style.display = 'none';
        } catch (err) { phIcon.style.display = 'inline-block'; }
      }, 30);

      return div;
    }

    function aceModeFromPath(path) {
      const ext = (path.split('.').pop() || '').toLowerCase();
      const map = {
        'js':'javascript','mjs':'javascript','cjs':'javascript',
        'ts':'typescript','jsx':'jsx','tsx':'tsx',
        'py':'python','java':'java','html':'html','htm':'html',
        'css':'css','json':'json','md':'markdown','markdown':'markdown',
        'sh':'sh','bash':'sh','yml':'yaml','yaml':'yaml','xml':'xml',
        'php':'php','sql':'sql','c':'c_cpp','cpp':'c_cpp','cc':'c_cpp','h':'c_cpp','hpp':'c_cpp',
        'rs':'rust','go':'golang','rb':'ruby','swift':'swift','kt':'kotlin','cs':'csharp',
        'jsonl':'json','txt':'text'
      };
      return map[ext] || 'text';
    }

    async function readFile(path) {
      selected = { path, is_dir: false };
      const editorEl = document.getElementById('editor');
      const filenameEl = document.getElementById('editor-filename');
      if (filenameEl) filenameEl.textContent = path;

      if (editorEl && window.ace) {
        const ed = ace.edit(editorEl);
        const editorContainer = document.getElementById('editor-container');
        if (editorContainer) editorContainer.classList.remove('hidden');

        ed.setValue('Loading...', -1);
        const saveBtn = document.getElementById('save-btn');
        if (saveBtn) saveBtn.disabled = true;

        try {
          const res = await fetch(apiBaseUrl + '/api/read?path=' + encodeURIComponent(path));
          const j = await res.json();
          if (!j.success) { ed.setValue('ERROR: ' + (j.message || 'unknown'), -1); showStatus('Read error: ' + (j.message || 'unknown'), true); return; }
          ed.setValue(j.content || '', -1);
          const mode = aceModeFromPath(path);
          try { ed.session.setMode('ace/mode/' + mode); } catch(e){}
          if (saveBtn) saveBtn.disabled = false;
          setTimeout(() => ed.resize(), 50);
          showStatus('File loaded: ' + path);
        } catch (err) {
          ed.setValue('ERROR: Could not read file.\n' + err.message, -1);
          if (saveBtn) saveBtn.disabled = true;
          showStatus('Error reading file: ' + err.message, true);
        }
      } else {
        try {
          const res = await fetch(apiBaseUrl + '/api/read?path=' + encodeURIComponent(path));
          const j = await res.json();
          if (!j.success) { alert('Read error: ' + j.message); return; }
        } catch (err) { alert('Read error: ' + err.message); }
      }
    }

    async function saveFile() {
      if (!selected || selected.is_dir) { alert('Select a file to save'); return; }
      const editorEl = document.getElementById('editor');
      let content = '';
      if (editorEl && window.ace) content = ace.edit(editorEl).getValue();
      try {
        const res = await fetch(apiBaseUrl + '/api/write', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: selected.path, content })
        });
        const j = await res.json();
        if (j.success) {
          showStatus('Saved ' + selected.path);
          refreshListing(cwd);
        } else alert('Save error: ' + j.message);
      } catch (err) { showStatus('Save failed: ' + err.message, true); }
    }

    function discardChanges() { if (!selected) return; readFile(selected.path); }

    async function promptNewFile() {
      const name = prompt('New file name (relative to current directory):');
      if (!name) return;
      const remote = pathJoin(cwd, name);
      try {
        const res = await fetch(apiBaseUrl + '/api/write', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ path: remote, content: '' })
        });
        const j = await res.json();
        if (j.success) refreshListing(cwd); else alert('Error: ' + j.message);
      } catch (err) { alert('Error: ' + err.message); }
    }

    async function promptNewFolder() {
      const name = prompt('New folder name (relative to current directory):');
      if (!name) return;
      const remote = pathJoin(cwd, name);
      try {
        const res = await fetch(apiBaseUrl + '/api/mkdir', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ path: remote }) });
        const j = await res.json();
        if (j.success) refreshListing(cwd); else alert('Error: ' + j.message);
      } catch (err) { alert('Error: ' + err.message); }
    }

    async function removeSelected() {
      if (!selected) { alert('Select file/folder first'); return; }
      if (!confirm('Delete ' + selected.path + ' ?')) return;
      try {
        const res = await fetch(apiBaseUrl + '/api/remove', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ path: selected.path }) });
        const j = await res.json();
        if (j.success) { selected = null; updateSelectionUI(); refreshListing(cwd); } else alert('Error: ' + j.message);
      } catch (err) { alert('Error: ' + err.message); }
    }

    async function renameSelected() {
      if (!selected) { alert('Select file/folder first'); return; }
      const newName = prompt('New name or full path:', selected.path);
      if (!newName) return;
      try {
        const res = await fetch(apiBaseUrl + '/api/rename', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ old: selected.path, new: newName }) });
        const j = await res.json();
        if (j.success) { selected = null; refreshListing(cwd); } else alert('Error: ' + j.message);
      } catch (err) { alert('Error: ' + err.message); }
    }

    async function downloadSelected() {
      if (!selected || selected.is_dir) { alert('Select a file to download'); return; }
      const url = apiBaseUrl + '/api/download?path=' + encodeURIComponent(selected.path);
      const a = document.createElement('a'); a.href = url; a.download = ''; document.body.appendChild(a); a.click(); a.remove();
    }

    async function doUpload() {
      const input = document.getElementById('fileUpload');
      if (!input || !input.files || input.files.length === 0) return;
      const file = input.files[0];
      const fd = new FormData(); fd.append('file', file); fd.append('remote_dir', cwd);
      try {
        const res = await fetch(apiBaseUrl + '/api/upload', { method: 'POST', body: fd });
        const j = await res.json();
        if (j.success) { alert('Uploaded'); refreshListing(cwd); input.value = ''; } else alert('Upload error: ' + j.message);
      } catch (err) { alert('Upload error: ' + err.message); }
    }

    function updateSelectionUI() {
      if (!selected) { const sp = document.getElementById('editor-filename'); if (sp) sp.textContent = 'Select a file to view/edit'; return; }
      const sp = document.getElementById('editor-filename'); if (sp) sp.textContent = selected.path;
    }

    function goUp() { if (!cwd || cwd === '/') return refreshListing('/'); const parts = cwd.split('/').filter(Boolean); parts.pop(); const np = '/' + parts.join('/'); refreshListing(np === '/' ? '/' : np); }

    // wire UI
    document.getElementById('connection-form')?.addEventListener('submit', async (e) => { e.preventDefault(); await connect(); });
    document.getElementById('current-path')?.addEventListener('click', () => { const parts = cwd.split('/').filter(Boolean); parts.pop(); const np = '/' + parts.join('/'); refreshListing(np === '/' ? '/' : np); });
    document.getElementById('close-editor-btn')?.addEventListener('click', closeEditor);

    // add create file button
    const explorerPanel = document.querySelector('#explorer-panel');
    if (explorerPanel) {
      const createFileBtn = document.createElement('button');
      createFileBtn.textContent = 'Create New File';
      createFileBtn.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg shadow-md transition-colors duration-200';
      createFileBtn.addEventListener('click', promptNewFile);
      explorerPanel.appendChild(createFileBtn);
    }

    // ace init
    window.addEventListener('load', () => {
      const editorEl = document.getElementById('editor');
      if (editorEl && window.ace) {
        const ed = ace.edit(editorEl);
        ed.setTheme('ace/theme/monokai');
        ed.session.setMode('ace/mode/text');
        ed.setOptions({ wrap: true, fontSize: 14 });
        
        ed.setShowPrintMargin(false);


        function resizeAce() { try { ed.resize(); } catch(e) {} }
        window.addEventListener('resize', resizeAce);
        setTimeout(resizeAce, 100);
      }
    });

    // close editor function
    function closeEditor() {
      const editorContainer = document.getElementById('editor-container');
      const editorEl = document.getElementById('editor');
      if (editorContainer) editorContainer.classList.add('hidden');
      if (editorEl && window.ace) {
        try {
          const ed = ace.edit(editorEl);
          ed.setValue('', -1);
          ed.session.setMode('ace/mode/text');
        } catch (e) {}
      }
      selected = null;
      const filenameEl = document.getElementById('editor-filename');
      if (filenameEl) filenameEl.textContent = 'No File Selected';
      const saveBtn = document.getElementById('save-btn');
      if (saveBtn) saveBtn.disabled = true;
    }
  </script>
</body>
</html>
